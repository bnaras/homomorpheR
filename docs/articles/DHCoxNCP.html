<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distributed Stratified Cox Regression using Non-Cooperating Parties â€¢ homomorpheR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Distributed Stratified Cox Regression using Non-Cooperating Parties">
<meta property="og:description" content="homomorpheR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">homomorpheR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2-5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/homomorphing.html">Maximum Likelihood Estimation</a>
    </li>
    <li>
      <a href="../articles/DHCox.html">Distributed Cox Regression</a>
    </li>
    <li>
      <a href="../articles/QueryNCP.html">Distributed Query Count using Noncooperating parties</a>
    </li>
    <li>
      <a href="../articles/DHCoxNCP.html">Distributed Cox Regression using Noncooperating parties</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/bnaras/homomorpheR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Distributed Stratified Cox Regression using
Non-Cooperating Parties</h1>
                        <h4 data-toc-skip class="author">Balasubramanian
Narasimhan</h4>
            
            <h4 data-toc-skip class="date">2022-03-30</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/bnaras/homomorpheR/blob/HEAD/vignettes/DHCoxNCP.Rmd" class="external-link"><code>vignettes/DHCoxNCP.Rmd</code></a></small>
      <div class="hidden name"><code>DHCoxNCP.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>It is only a short way from the toy MLE example to a more useful
example using Cox regression.</p>
<p>But first, we need the <code>survival</code> package and the
<code>homomopheR</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/therneau/survival" class="external-link">"survival"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"this vignette requires the survival package"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/bnaras/homomorpheR" class="external-link">homomorpheR</a></span><span class="op">)</span></code></pre></div>
<p>We generate some simulated data for the purpose of this example. We
will have three sites each with patient data (sizes 1000, 500 and 1500)
respectively, containing</p>
<ul>
<li>
<code>sex</code> (0, 1) for male/female</li>
<li>
<code>age</code> between 40 and 70</li>
<li>a biomarker <code>bm</code>
</li>
<li>a <code>time</code> to some event of interest</li>
<li>an indicator <code>event</code> which is 1 if an event was observed
and 0 otherwise.</li>
</ul>
<p>It is common to fit stratified models using sites as strata since the
patient characteristics usually differ from site to site. So the
baseline hazards (<code>lambdaT</code>) are different for each site but
they share common coefficients (<code>beta.1</code>, <code>beta.2</code>
and <code>beta.3</code> for <code>age</code>, <code>sex</code> and
<code>bm</code> respy.) for the model. See <span class="citation">(Terry
M. Therneau and Patricia M. Grambsch 2000)</span> by Therneau and
Grambsch for details. So our model for each site <span class="math inline">\(i\)</span> is</p>
<p><span class="math display">\[
S(t, age, sex, bm) =
[S_0^i(t)]^{\exp(\beta_1 age + \beta_2 sex + \beta_3 bm)}
\]</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sampleSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>n1 <span class="op">=</span> <span class="fl">1000</span>, n2 <span class="op">=</span> <span class="fl">500</span>, n3 <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>

<span class="va">beta.1</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">.015</span>; <span class="va">beta.2</span> <span class="op">&lt;-</span> <span class="fl">.2</span>; <span class="va">beta.3</span> <span class="op">&lt;-</span> <span class="fl">.001</span>;

<span class="va">lambdaT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">lambdaC</span> <span class="op">&lt;-</span> <span class="fl">2</span>

<span class="va">coxData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">)</span>,
                  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">sampleSize</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                      <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">40</span><span class="op">:</span><span class="fl">70</span>, size <span class="op">=</span> <span class="va">sampleSize</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                      <span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
                      <span class="va">trueTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">rweibull</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                                           shape <span class="op">=</span> <span class="fl">1</span>,
                                           scale <span class="op">=</span> <span class="va">lambdaT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">beta.1</span> <span class="op">*</span> <span class="va">age</span> <span class="op">+</span> <span class="va">beta.2</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">beta.3</span> <span class="op">*</span> <span class="va">bm</span> <span class="op">)</span><span class="op">)</span>
                      <span class="va">censoringTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">rweibull</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                                                shape <span class="op">=</span> <span class="fl">1</span>,
                                                scale <span class="op">=</span> <span class="va">lambdaC</span><span class="op">)</span>
                      <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTime</span>, <span class="va">censoringTime</span><span class="op">)</span>
                      <span class="va">event</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="va">trueTime</span><span class="op">)</span>
                      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>stratum <span class="op">=</span> <span class="va">i</span>,
                                 sex <span class="op">=</span> <span class="va">sex</span>,
                                 age <span class="op">=</span> <span class="va">age</span>,
                                 bm <span class="op">=</span> <span class="va">bm</span>,
                                 time <span class="op">=</span> <span class="va">time</span>,
                                 event <span class="op">=</span> <span class="va">event</span><span class="op">)</span>
                  <span class="op">}</span><span class="op">)</span></code></pre></div>
<p>So here is a summary of the data for the three sites.</p>
<div class="section level4">
<h4 id="site-1">Site 1<a class="anchor" aria-label="anchor" href="#site-1"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">coxData</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 'data.frame':    1000 obs. of  6 variables:</span>
<span class="co">##  $ stratum: int  1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">##  $ sex    : num  1 0 1 1 1 1 1 0 0 1 ...</span>
<span class="co">##  $ age    : int  47 69 70 47 41 51 59 45 43 69 ...</span>
<span class="co">##  $ bm     : num  -0.516 -1.375 1.01 0.454 0.275 ...</span>
<span class="co">##  $ time   : num  1.37 0.95 2.35 2.48 1.93 ...</span>
<span class="co">##  $ event  : logi  FALSE TRUE TRUE TRUE FALSE FALSE ...</span></code></pre>
</div>
<div class="section level4">
<h4 id="site-2">Site 2<a class="anchor" aria-label="anchor" href="#site-2"></a>
</h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">coxData</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 'data.frame':    500 obs. of  6 variables:</span>
<span class="co">##  $ stratum: int  2 2 2 2 2 2 2 2 2 2 ...</span>
<span class="co">##  $ sex    : num  0 1 0 1 1 1 0 1 1 1 ...</span>
<span class="co">##  $ age    : int  54 63 53 70 40 57 48 54 63 47 ...</span>
<span class="co">##  $ bm     : num  -0.3243 0.2531 0.0464 0.8149 -0.1921 ...</span>
<span class="co">##  $ time   : num  1.10483 0.34804 0.01602 0.68249 0.00157 ...</span>
<span class="co">##  $ event  : logi  FALSE FALSE TRUE TRUE FALSE TRUE ...</span></code></pre>
</div>
<div class="section level4">
<h4 id="site-3">Site 3<a class="anchor" aria-label="anchor" href="#site-3"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">coxData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 'data.frame':    1500 obs. of  6 variables:</span>
<span class="co">##  $ stratum: int  3 3 3 3 3 3 3 3 3 3 ...</span>
<span class="co">##  $ sex    : num  1 0 0 1 1 1 0 1 0 1 ...</span>
<span class="co">##  $ age    : int  55 70 49 60 44 42 58 62 61 68 ...</span>
<span class="co">##  $ bm     : num  -0.9554 0.8138 0.0425 -1.2272 0.3244 ...</span>
<span class="co">##  $ time   : num  0.0733 1.9869 2.2946 0.1231 1.0602 ...</span>
<span class="co">##  $ event  : logi  TRUE FALSE FALSE TRUE FALSE FALSE ...</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="section"></h2>
</div>
<div class="section level2">
<h2 id="aggregated-fit">Aggregated fit<a class="anchor" aria-label="anchor" href="#aggregated-fit"></a>
</h2>
<p>If the data were all aggregated in one place, it would very simple to
fit the model. Below, we row-bind the data from the three sites.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span>
                                <span class="va">age</span> <span class="op">+</span> <span class="va">bm</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html" class="external-link">strata</a></span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span>,
                            data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">coxData</span><span class="op">)</span><span class="op">)</span>
<span class="va">aggModel</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time, event) ~ sex + age + bm + strata(stratum), </span>
<span class="co">##     data = do.call(rbind, coxData))</span>
<span class="co">## </span>
<span class="co">##          coef exp(coef)  se(coef)      z       p</span>
<span class="co">## sex -0.160493  0.851723  0.050627 -3.170 0.00152</span>
<span class="co">## age  0.010057  1.010108  0.002835  3.547 0.00039</span>
<span class="co">## bm  -0.005989  0.994029  0.025208 -0.238 0.81222</span>
<span class="co">## </span>
<span class="co">## Likelihood ratio test=22.82  on 3 df, p=4.413e-05</span>
<span class="co">## n= 3000, number of events= 1575</span></code></pre>
<p>Here <code>age</code> and <code>sex</code> are significant, but
<code>bm</code> is not. The estimates <span class="math inline">\(\hat{\beta}\)</span> are
<code>(-0.180, .020, .007)</code>.</p>
<p>We can also print out the value of the (partial) log-likelihood at
the MLE.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggModel</span><span class="op">$</span><span class="va">loglik</span></code></pre></div>
<pre><code><span class="co">## [1] -9534.495 -9523.087</span></code></pre>
<p>The first is the value at the initial parameter value
<code>(0, 0, 0)</code> and the second is the value at the MLE.</p>
<div class="section level3">
<h3 id="distributed-computation">Distributed Computation<a class="anchor" aria-label="anchor" href="#distributed-computation"></a>
</h3>
<p>Assume now that the data <code>coxData</code> is distributed between
three sites none of whom want to share actual data among each other or
even with a master computation process. They wish to keep their data
secret but are willing, together, to provide the sum of their local
negative log-likelihoods. They wish to do this in a manner so that the
master process is <em>unable to associate the contribution to the
likelihood from each site</em>.</p>
<p>The overall likelihood function <span class="math inline">\(l(\beta)\)</span> for the entire data is the sum
of the likelihoods at each site: <span class="math inline">\(l(\beta) =
l_1(\beta)+l_2(\beta)+l_3(\beta).\)</span> How can this likelihood be
computed while preventing the master from knowing the individual
contributions of each site?</p>
<p>The key to ensuring that each site will not reveal the actual value
<span class="math inline">\(l_i(\beta)\)</span> for any <span class="math inline">\(\beta\)</span> involves the use of two
<em>non-cooperating</em> parties, say, NCP1 and NCP2. Site <span class="math inline">\(i\)</span> sends <span class="math inline">\(E(l_i(\beta) + r_i)\)</span> to NCP1 and <span class="math inline">\(E(l_i(\beta) - r_i)\)</span> to NCP2, where <span class="math inline">\(E(x)\)</span> denotes the encrypted value of <span class="math inline">\(x\)</span> and <span class="math inline">\(r_i\)</span> is a random quantity generated anew
for each site and each <span class="math inline">\(\beta\)</span>. NCP1
can compute <span class="math inline">\(\sum_{i=1}^3E(l_i +
r_i)\)</span> and NCP2 can compute <span class="math inline">\(\sum_{i=1}^3E(l_i - r_i)\)</span>, but
individually, neither has a handle on <span class="math inline">\(l =
\sum_{i=1}^3 l_i\)</span>.</p>
<p>The <em>master</em> process can retrieve <span class="math inline">\(\sum_{i=1}^3E(l_i + r_i)\)</span> and <span class="math inline">\(\sum_{i=1}^3E(l_i - r_i)\)</span> from NCP1 and
NCP2 respectively. Each is an encrypted value of the sum of the
likelihood contributions from all sites, obfuscated by a random term,
and hence is random to the master. However, the master using the
associative and homomorphic properties of <span class="math inline">\(E(.)\)</span>, can compute:</p>
<p><span class="math display">\[
\sum_{i=1}^3E(l_i + r_i) +\sum_{i=1}^3E(l_i - r_i) = \sum_{i=1}^3E(l_i
+ r_i + l_i - r_i)  = \sum_{i=1}^3E(2l_i)  = E(2l)
\]</span></p>
<p>since <span class="math inline">\(l = l_1 + l_2 + l_3\)</span>. The
master can now decrypt the result and obtain <span class="math inline">\(2l\)</span>!</p>
<p>This is pictorially shown below.</p>
<p><img src="assets/mpc.png"></p>
<p>The red arrows show the master proposing a value <span class="math inline">\(\beta\)</span> to each of the sites, which reply
back to NCP1 and NCP2. The master then retrieves the values from NCP1
and NCP2 and sums them.</p>
<div class="section level4">
<h4 id="a-modified-topology">A Modified Topology<a class="anchor" aria-label="anchor" href="#a-modified-topology"></a>
</h4>
<p>The drawback of the above scheme is that channels of communication
have to be established from each site to the master process and also to
the two non-cooperating parties NCP1 and NCP2. If the number of
participating sites in a computation changes, then both the master and
NCP1 and NCP2 have to be made aware of the change.</p>
<p>It would be simpler if only NCP1 and NCP2 can talk to both the master
and the sites. Such a situation would arise, for example, when the sites
are all participating in a disease specific registry. The parties NCP1
and NCP2 would probably be set up once and any new site that has to be
onboarded needs only to be known to P1 and P2. This has the added
advantage of hiding the number of sites, which could even be 1!</p>
<p>Such a communication topology would mean that the <span class="math inline">\(\beta\)</span> values have be funneled to the
sites through NCP1 and NCP2 and that can be easily accomplished. The
picture below shows this configuration and looks more complicated than
it actually is.</p>
<p><img src="assets/mpc2.png"></p>
<p>To summarize, the modified scheme has several characteristics:</p>
<ul>
<li>The master only communicates with NCP1 and NCP2</li>
<li>NCP1 and NCP2 are the only parties communicating with both the
master and sites</li>
<li>NCP1 and NCP2 are the only ones that know how many sites are
participating</li>
<li>New sites can be added and only NCP1 and NCP2 need to account for
them while the master remains oblivous to the number of sites; so
<em>the scheme works even with one site</em>
</li>
<li>It appears that there is unnecessary communication of the same
information, i.e.Â <span class="math inline">\(\beta\)</span> is being
sent twice to each site from each of the NCP1 and NCP2. This is easily
mitigated by engineering either by using a broker between NCP1 and NCP2,
or the sites caching their results for a short period to avoid
recomputation.</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h3>
<p>The above implementation assumes that the encryption and decryption
can happen with real numbers which is not the actual situation. Instead,
we use rational approximations using a large denominator, <span class="math inline">\(2^{256}\)</span>, say. In the future, of course,
we need to build an actual library is built with rigorous algorithms
guaranteeing precision and overflow/undeflow detection. For now, this is
just an ad hoc implementation.</p>
<p>Also, since we are only using homomorphic additive properties, a
partial homomorphic scheme such as the Paillier Encryption system will
be sufficient for our computations.</p>
<p>We define classes to encapsulate our sites, non-cooperating parties
and a master process.</p>
<div class="section level4">
<h4 id="the-site-class">The Site Class<a class="anchor" aria-label="anchor" href="#the-site-class"></a>
</h4>
<p>Our site class will compute the partial log likelihood on site data
given a parameter <span class="math inline">\(\beta\)</span>. Note how
the private <code>nll</code> method takes care to split the result into
an integer and fractional part while performing the arithmetic
operations. (The latter is approximated by a rational number.)</p>
<p>In the code below, we exploit a feature of <code>coxph</code>: a
control parameter can be passed to evaluate the partial likelihood at a
given <span class="math inline">\(\beta\)</span> value. We also use a
cache so that we can distribute each piece of the encrypted likelihood
<span class="math inline">\(E(l_i - r_i)\)</span> and <span class="math inline">\(E(l_i + r_i)\)</span> to the two non-cooperating
parties.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Site</span> <span class="op">&lt;-</span>
    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span>
            <span class="st">"Site"</span>,
            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                <span class="co">## name of the site</span>
                name <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## local data</span>
                data <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## Control variable for cox regression</span>
                cph.control <span class="op">=</span> <span class="cn">NA</span>,
                beta_cache <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,
                local_nll <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">{</span>
                    <span class="co">## Check if value is cached</span>
                    <span class="va">beta_hash</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span><span class="va">beta</span>, algo <span class="op">=</span> <span class="st">"xxhash64"</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">result</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">beta_cache</span><span class="op">[[</span><span class="va">beta_hash</span><span class="op">]</span><span class="op">]</span>
                    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                        <span class="co">## We're worker, so compute local negative log likelihood</span>
                        <span class="va">nllValue</span>  <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span>
                            <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">bm</span>,
                                       data <span class="op">=</span> <span class="va">private</span><span class="op">$</span><span class="va">data</span>,
                                       init <span class="op">=</span> <span class="va">beta</span>,
                                       control <span class="op">=</span> <span class="va">private</span><span class="op">$</span><span class="va">cph.control</span><span class="op">)</span>
                            <span class="op">-</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">loglik</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
                        <span class="op">}</span>,
                        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NA</span><span class="op">)</span>
                        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">nllValue</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                            <span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span>
                            <span class="co">## Generate random offset for int and frac parts</span>
                            <span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int <span class="op">=</span> <span class="fu"><a href="../reference/random.bigz.html">random.bigz</a></span><span class="op">(</span>nBits <span class="op">=</span> <span class="fl">256</span><span class="op">)</span>,
                                           frac <span class="op">=</span> <span class="fu"><a href="../reference/random.bigz.html">random.bigz</a></span><span class="op">(</span>nBits <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">)</span>
                            <span class="co">## 2. Add to neg log likelihood</span>
                            <span class="va">result.int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">nllValue</span><span class="op">)</span>
                            <span class="va">result.frac</span> <span class="op">&lt;-</span> <span class="va">nllValue</span> <span class="op">-</span> <span class="va">result.int</span>
                            <span class="co">## Approximate fractional part by a rational</span>
                            <span class="va">result.fracnum</span> <span class="op">&lt;-</span> <span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/biginteger.html" class="external-link">as.bigz</a></span><span class="op">(</span><span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/bigrational.html" class="external-link">numerator</a></span><span class="op">(</span><span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/bigrational.html" class="external-link">as.bigq</a></span><span class="op">(</span><span class="va">result.frac</span><span class="op">)</span> <span class="op">*</span> <span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span><span class="op">)</span>
                            <span class="va">result</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                                int1 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.int</span> <span class="op">-</span> <span class="va">offset</span><span class="op">$</span><span class="va">int</span><span class="op">)</span>,
                                frac1 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.fracnum</span> <span class="op">-</span> <span class="va">offset</span><span class="op">$</span><span class="va">frac</span><span class="op">)</span>,
                                int2 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.int</span> <span class="op">+</span> <span class="va">offset</span><span class="op">$</span><span class="va">int</span><span class="op">)</span>,
                                frac2 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.fracnum</span> <span class="op">+</span> <span class="va">offset</span><span class="op">$</span><span class="va">frac</span><span class="op">)</span>
                            <span class="op">)</span>
                            <span class="va">private</span><span class="op">$</span><span class="va">beta_cache</span><span class="op">[[</span><span class="va">beta_hash</span><span class="op">]</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="va">result</span>
                        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                            <span class="va">result</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int1 <span class="op">=</span> <span class="cn">NA</span>, frac1 <span class="op">=</span> <span class="cn">NA</span>, int2 <span class="op">=</span> <span class="cn">NA</span>, frac2 <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
                        <span class="op">}</span>
                    <span class="op">}</span>
                    <span class="va">result</span>
                <span class="op">}</span>
            <span class="op">)</span>,
            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                count <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## Common denominator for approximate real arithmetic</span>
                den <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## The master's public key; everyone has this</span>
                pubkey <span class="op">=</span> <span class="cn">NA</span>,
                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">cph.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.control.html" class="external-link">coxph.control</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"iter.max"</span>, <span class="fl">0</span><span class="op">)</span>
                <span class="op">}</span>,
                setPublicKey <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">pubkey</span>
                <span class="op">}</span>,
                setDenominator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">den</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">=</span> <span class="va">den</span>
                <span class="op">}</span>,
                <span class="co">## neg log lik,</span>
                nll <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span>, <span class="va">party</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">result</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="fu">local_nll</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>
                    <span class="kw">if</span> <span class="op">(</span><span class="va">party</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">int1</span>, frac <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">frac1</span><span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">int2</span>, frac <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">frac2</span><span class="op">)</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">)</span>
        <span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-non-cooperating-parties-class">The Non-cooperating Parties Class<a class="anchor" aria-label="anchor" href="#the-non-cooperating-parties-class"></a>
</h4>
<p>The non-cooperating parties can communicate with the sites. So they
have methods for adding sites, passing on public keys from the master
etc. The <code>nll</code> method for this class merely calls each site
to compute the result and adds them up before sending it on to the
master, so that the master has no idea of the individual
contributions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NCParty</span> <span class="op">&lt;-</span>
    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span>
            <span class="st">"NCParty"</span>,
            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                <span class="co">## name of the site</span>
                name <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## NC party number</span>
                number <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## The master</span>
                master <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## The sites</span>
                sites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
            <span class="op">)</span>,
            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                <span class="co">## The master's public key; everyone has this</span>
                pubkey <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## The denoinator for rational arithmetic</span>
                den <span class="op">=</span> <span class="cn">NA</span>,
                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">number</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">number</span>  <span class="op">&lt;-</span> <span class="va">number</span>
                <span class="op">}</span>,
                setPublicKey <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">pubkey</span>
                    <span class="co">## Propagate to sites</span>
                    <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">site</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span>
                    <span class="op">}</span>
                <span class="op">}</span>,
                setDenominator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">den</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">&lt;-</span> <span class="va">den</span>
                    <span class="co">## Propagate to sites</span>
                    <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">site</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">den</span><span class="op">)</span>
                    <span class="op">}</span>
                <span class="op">}</span>,
                addSite <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">sites</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">sites</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span>
                <span class="op">}</span>,
                <span class="co">## neg log lik</span>
                nll <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">pubkey</span>  <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span>
                    <span class="va">results</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sites</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="fu">nll</span><span class="op">(</span><span class="va">beta</span>, <span class="va">private</span><span class="op">$</span><span class="va">number</span><span class="op">)</span><span class="op">)</span>
                    <span class="co">## Accumulate the integer and fractional parts</span>
                    <span class="va">n</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
                    <span class="va">sumInt</span>  <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">int</span>
                    <span class="va">sumFrac</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">frac</span>
                    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">sumInt</span>  <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">sumInt</span>, <span class="va">results</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">int</span><span class="op">)</span>
                        <span class="va">sumFrac</span>  <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">sumFrac</span>, <span class="va">results</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">frac</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int <span class="op">=</span> <span class="va">sumInt</span>, frac <span class="op">=</span> <span class="va">sumFrac</span><span class="op">)</span>
                <span class="op">}</span>
            <span class="op">)</span>
        <span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-master-class">The Master Class<a class="anchor" aria-label="anchor" href="#the-master-class"></a>
</h4>
<p>The master process</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Master</span>  <span class="op">&lt;-</span>
    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span>
            <span class="st">"Master"</span>,
            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                <span class="co">## name of the site</span>
                name <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## Private and public keys</span>
                keys <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## Non cooperating party 1</span>
                nc_party_1 <span class="op">=</span> <span class="cn">NA</span>,
                <span class="co">## Non cooperating party 2</span>
                nc_party_2 <span class="op">=</span> <span class="cn">NA</span>
            <span class="op">)</span>,
            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                <span class="co">## Denominator for rational arithmetic</span>
                den  <span class="op">=</span> <span class="cn">NA</span>,
                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PaillierKeyPair.html">PaillierKeyPair</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fl">1024</span><span class="op">)</span> <span class="co">## Generate new public and private key.</span>
                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">&lt;-</span> <span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/bigrational.html" class="external-link">as.bigq</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">256</span>  <span class="co">#Our denominator for rational approximations</span>
                <span class="op">}</span>,
                setNCParty1  <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span> <span class="op">&lt;-</span> <span class="va">site</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span><span class="op">)</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span>
                <span class="op">}</span>,
                setNCParty2  <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span> <span class="op">&lt;-</span> <span class="va">site</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span><span class="op">)</span>
                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span>
                <span class="op">}</span>,
                <span class="co">## neg log lik</span>
                nLL <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">pubkey</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span>
                    <span class="va">privkey</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="fu">getPrivateKey</span><span class="op">(</span><span class="op">)</span>
                    <span class="va">result1</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">nll</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>
                    <span class="va">result2</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">nll</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>
                    <span class="co">## Accumulate the integer and fractional parts</span>
                    <span class="va">sumInt</span>  <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">result1</span><span class="op">$</span><span class="va">int</span>, <span class="va">result2</span><span class="op">$</span><span class="va">int</span><span class="op">)</span>
                    <span class="va">sumFrac</span>  <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">result1</span><span class="op">$</span><span class="va">frac</span>, <span class="va">result2</span><span class="op">$</span><span class="va">frac</span><span class="op">)</span>
                    <span class="va">intResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">privkey</span><span class="op">$</span><span class="fu">decrypt</span><span class="op">(</span><span class="va">sumInt</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">fracResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/bigrational.html" class="external-link">as.bigq</a></span><span class="op">(</span><span class="va">privkey</span><span class="op">$</span><span class="fu">decrypt</span><span class="op">(</span><span class="va">sumFrac</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span>
                    <span class="co">## Since we 2L, we divide by 2.</span>
                    <span class="op">(</span><span class="va">intResult</span> <span class="op">+</span> <span class="va">fracResult</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span>
                <span class="op">}</span>
            <span class="op">)</span>
        <span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>We are now ready to use our sites in the computation.</p>
<div class="section level4">
<h4 id="create-sites">1. Create sites<a class="anchor" aria-label="anchor" href="#create-sites"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">site1</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 1"</span>, data <span class="op">=</span> <span class="va">coxData</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">site2</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 2"</span>, data <span class="op">=</span> <span class="va">coxData</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">site3</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 3"</span>, data <span class="op">=</span> <span class="va">coxData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="va">sites</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>site1 <span class="op">=</span> <span class="va">site1</span>, site2 <span class="op">=</span> <span class="va">site2</span>, site3 <span class="op">=</span> <span class="va">site3</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-non-cooperating-parties">2. Create Non-cooperating parties<a class="anchor" aria-label="anchor" href="#create-non-cooperating-parties"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ncp1</span>  <span class="op">&lt;-</span> <span class="va">NCParty</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"NCP1"</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">ncp2</span>  <span class="op">&lt;-</span> <span class="va">NCParty</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"NCP1"</span>, <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>We add sites to the non-cooperating parties.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">ncp1</span><span class="op">$</span><span class="fu">addSite</span><span class="op">(</span><span class="va">s</span><span class="op">)</span>
    <span class="va">ncp2</span><span class="op">$</span><span class="fu">addSite</span><span class="op">(</span><span class="va">s</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-the-master-process">3. Create the master process<a class="anchor" aria-label="anchor" href="#create-the-master-process"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">master</span>  <span class="op">&lt;-</span> <span class="va">Master</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"Master"</span><span class="op">)</span></code></pre></div>
<p>We next connect the master to the non-cooperating parties.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">master</span><span class="op">$</span><span class="fu">setNCParty1</span><span class="op">(</span><span class="va">ncp1</span><span class="op">)</span>
<span class="va">master</span><span class="op">$</span><span class="fu">setNCParty2</span><span class="op">(</span><span class="va">ncp2</span><span class="op">)</span></code></pre></div>
<p>At this point the communication graph has been defined between the
master and non-cooperating parties and the non-cooperating parties and
the sites.</p>
</div>
<div class="section level4">
<h4 id="perform-the-likelihood-estimation">4. Perform the likelihood estimation<a class="anchor" aria-label="anchor" href="#perform-the-likelihood-estimation"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats4</span><span class="op">)</span>
<span class="va">nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span>, <span class="va">bm</span><span class="op">)</span> <span class="va">master</span><span class="op">$</span><span class="fu">nLL</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span>, <span class="va">bm</span><span class="op">)</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats4/mle.html" class="external-link">mle</a></span><span class="op">(</span><span class="va">nll</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fl">0</span>, sex <span class="op">=</span> <span class="fl">0</span>, bm <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="compare-the-results">5. Compare the results<a class="anchor" aria-label="anchor" href="#compare-the-results"></a>
</h4>
<p>The summary will show the results.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Maximum likelihood estimation</span>
<span class="co">## </span>
<span class="co">## Call:</span>
<span class="co">## mle(minuslogl = nll, start = list(age = 0, sex = 0, bm = 0))</span>
<span class="co">## </span>
<span class="co">## Coefficients:</span>
<span class="co">##         Estimate  Std. Error</span>
<span class="co">## age -0.160493329 0.050626611</span>
<span class="co">## sex  0.010057265 0.002835374</span>
<span class="co">## bm  -0.005988214 0.025208370</span>
<span class="co">## </span>
<span class="co">## -2 log L: 19046.17</span></code></pre>
<p>Note how the estimated coefficients and standard errors closely match
the full model summary below.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">aggModel</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time, event) ~ sex + age + bm + strata(stratum), </span>
<span class="co">##     data = do.call(rbind, coxData))</span>
<span class="co">## </span>
<span class="co">##   n= 3000, number of events= 1575 </span>
<span class="co">## </span>
<span class="co">##          coef exp(coef)  se(coef)      z Pr(&gt;|z|)    </span>
<span class="co">## sex -0.160493  0.851723  0.050627 -3.170  0.00152 ** </span>
<span class="co">## age  0.010057  1.010108  0.002835  3.547  0.00039 ***</span>
<span class="co">## bm  -0.005989  0.994029  0.025208 -0.238  0.81222    </span>
<span class="co">## ---</span>
<span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">## </span>
<span class="co">##     exp(coef) exp(-coef) lower .95 upper .95</span>
<span class="co">## sex    0.8517      1.174    0.7713    0.9406</span>
<span class="co">## age    1.0101      0.990    1.0045    1.0157</span>
<span class="co">## bm     0.9940      1.006    0.9461    1.0444</span>
<span class="co">## </span>
<span class="co">## Concordance= 0.536  (se = 0.009 )</span>
<span class="co">## Likelihood ratio test= 22.82  on 3 df,   p=4e-05</span>
<span class="co">## Wald test            = 22.81  on 3 df,   p=4e-05</span>
<span class="co">## Score (logrank) test = 22.85  on 3 df,   p=4e-05</span></code></pre>
<p>And the log likelihood of the distributed homomorphic fit also
matches that of the model on aggregated data:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"logLik(MLE fit): %f, logLik(Agg. fit): %f.\n"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, <span class="va">aggModel</span><span class="op">$</span><span class="va">loglik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## logLik(MLE fit): -9523.087001, logLik(Agg. fit): -9523.087001.</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-survival-book" class="csl-entry">
Terry M. Therneau, and Patricia M. Grambsch. 2000. <em>Modeling Survival
Data: Extending the <span>C</span>ox Model</em>. New York:
Springer-Verlag.
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://naras.su.domains" class="external-link">Balasubramanian
Narasimhan</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
