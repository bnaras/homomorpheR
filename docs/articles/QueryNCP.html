<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Distributed Query Count using Non-Cooperating Parties • homomorpheR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Distributed Query Count using Non-Cooperating Parties">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">homomorpheR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/homomorphing.html">Maximum Likelihood Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/DHCox.html">Distributed Cox Regression</a></li>
    <li><a class="dropdown-item" href="../articles/QueryNCP.html">Distributed Query Count using Noncooperating parties</a></li>
    <li><a class="dropdown-item" href="../articles/DHCoxNCP.html">Distributed Cox Regression using Noncooperating parties</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bnaras/homomorpheR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Distributed Query Count using Non-Cooperating Parties</h1>
                        <h4 data-toc-skip class="author">Balasubramanian
Narasimhan</h4>
            
            <h4 data-toc-skip class="date">2025-04-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bnaras/homomorpheR/blob/HEAD/vignettes/QueryNCP.Rmd" class="external-link"><code>vignettes/QueryNCP.Rmd</code></a></small>
      <div class="d-none name"><code>QueryNCP.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>We demonstrate the use of non-cooperating parties to run a
distributed query count computation using the <code>homomorpheR</code>
package a simulated data set containing:</p>
<ul>
<li>
<code>sex</code> (F, M) for female/male</li>
<li>
<code>age</code> between 40 and 70</li>
<li>
<code>bm</code> a biomarker</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">130</span><span class="op">)</span></span>
<span><span class="va">sample_size</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">15</span>, <span class="fl">25</span><span class="op">)</span></span>
<span><span class="va">query_data</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">tmp</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">sample_size</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">start</span>  <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">end</span>  <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">id_list</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span><span class="va">seq</span>, from <span class="op">=</span> <span class="va">start</span>, to <span class="op">=</span> <span class="va">end</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sample_size</span><span class="op">)</span>,</span>
<span>           <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>               <span class="va">id</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"P%4d"</span>, <span class="va">id_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>               <span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"F"</span>, <span class="st">"M"</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">sample_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>               <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">40</span><span class="op">:</span><span class="fl">70</span>, size <span class="op">=</span> <span class="va">sample_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>               <span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample_size</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span>, sex <span class="op">=</span> <span class="va">sex</span>, age <span class="op">=</span> <span class="va">age</span>, bm <span class="op">=</span> <span class="va">bm</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>           <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="site-1">Site 1<a class="anchor" aria-label="anchor" href="#site-1"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">query_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    60 obs. of  4 variables:</span></span>
<span><span class="co">##  $ id : chr  "P   1" "P   2" "P   3" "P   4" ...</span></span>
<span><span class="co">##  $ sex: chr  "F" "F" "F" "M" ...</span></span>
<span><span class="co">##  $ age: int  43 67 66 59 63 52 55 46 43 60 ...</span></span>
<span><span class="co">##  $ bm : num  1.252 -1.01 0.551 -0.379 0.284 ...</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="site-2">Site 2<a class="anchor" aria-label="anchor" href="#site-2"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">query_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    15 obs. of  4 variables:</span></span>
<span><span class="co">##  $ id : chr  "P  61" "P  62" "P  63" "P  64" ...</span></span>
<span><span class="co">##  $ sex: chr  "M" "F" "M" "F" ...</span></span>
<span><span class="co">##  $ age: int  53 64 45 61 55 65 65 51 53 47 ...</span></span>
<span><span class="co">##  $ bm : num  0.698 -0.447 -0.224 1.086 1.188 ...</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="site-3">Site 3<a class="anchor" aria-label="anchor" href="#site-3"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">query_data</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    25 obs. of  4 variables:</span></span>
<span><span class="co">##  $ id : chr  "P  76" "P  77" "P  78" "P  79" ...</span></span>
<span><span class="co">##  $ sex: chr  "M" "M" "M" "M" ...</span></span>
<span><span class="co">##  $ age: int  69 70 41 63 42 57 43 55 68 46 ...</span></span>
<span><span class="co">##  $ bm : num  -1.682 1.363 1.273 -0.68 0.625 ...</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="aggregated-query">Aggregated Query<a class="anchor" aria-label="anchor" href="#aggregated-query"></a>
</h2>
<p>If the data were all aggregated in one place, it would very simple to
query it. Let us run a sample query on this aggregated data set for the
condition
<code>age &lt; 50 &amp; sex == 'F' &amp; bm &lt; 0.2</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">query_data</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&lt;</span> <span class="fl">50</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">'F'</span> <span class="op">&amp;</span> <span class="va">bm</span> <span class="op">&lt;</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 11</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="distributed-computation">Distributed Computation<a class="anchor" aria-label="anchor" href="#distributed-computation"></a>
</h2>
<p>Assume now that the data <code>query_data</code> is distributed
between three sites none of whom want to share actual data among each
other or even with a master computation process. They wish to keep their
data secret but are willing, together, to provide the sum of the total
count. They wish to do this in a manner so that the master process is
<em>unable to associate the contribution to the likelihood from each
site</em>.</p>
<p>The overall query count for for the entire data is the sum of the
counts at each site. How can this count be computed while preventing the
master from knowing the individual contributions of each site?</p>
<p>We will use two <em>non-cooperating parties</em>, say NCP1 and NCP2,
to accomplish this. These parties do not talk to each other, but do talk
to the sites and the master process. Site
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
sends
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E(c_i + r_i)</annotation></semantics></math>
to NCP1 and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E(c_i - r_i)</annotation></semantics></math>
to NCP2, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mi>i</mi></msub><annotation encoding="application/x-tex">c_i</annotation></semantics></math>
is the actual count,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E(c_i)</annotation></semantics></math>
denotes the encrypted value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mi>i</mi></msub><annotation encoding="application/x-tex">c_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics></math>
is a random quantity generated anew for each site. NCP1 can compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3E(c_i + r_i)</annotation></semantics></math>
and NCP2 can compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3E(c_i -
r_i)</annotation></semantics></math>, but individually, neither has a
handle on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">l = \sum_{i=1}^3
c_i</annotation></semantics></math>.</p>
<p>The <em>master</em> process can retrieve
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3E(c_i + r_i)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3E(c_i - r_i)</annotation></semantics></math>
from NCP1 and NCP2 respectively. Each is an encrypted value of the sum
of counts from all sites, obfuscated by random terms, and hence is
random to the master. However, the master using the associative and
homomorphic properties of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mi>.</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E(.)</annotation></semantics></math>,
can compute:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>c</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mo>+</mo><msub><mi>c</mi><mi>i</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mn>2</mn><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mn>2</mn><mi>c</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\sum_{i=1}^3E(c_i + r_i) +\sum_{i=1}^3E(c_i - r_i) = \sum_{i=1}^3E(c_i
+ r_i + c_i - r_i)  = \sum_{i=1}^3E(2c_i)  = E(2c)
</annotation></semantics></math></p>
<p>since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><msub><mi>c</mi><mn>1</mn></msub><mo>+</mo><msub><mi>c</mi><mn>2</mn></msub><mo>+</mo><msub><mi>c</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">c = c_1 + c_2 + c_3</annotation></semantics></math>
is the grant total count. The master can now decrypt the result and
obtain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>!</p>
<p>This is pictorially shown below.</p>
<p><img src="assets%2Fnc-query-masters-v1.png"></p>
<p>The red arrows show the master proposing a value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
to each of the sites, which reply back to NCP1 and NCP2. The master then
retrieves the values from NCP1 and NCP2 and sums them.</p>
<div class="section level3">
<h3 id="a-modified-topology">A Modified Topology<a class="anchor" aria-label="anchor" href="#a-modified-topology"></a>
</h3>
<p>The drawback of the above scheme is that channels of communication
have to be established from each site to the master process and also to
the two non-cooperating parties NCP1 and NCP2. If the number of
participating sites in a computation changes, then both the master and
NCP1 and NCP2 have to be made aware of the change.</p>
<p>It would be simpler if only NCP1 and NCP2 can talk to both the master
and the sites. Such a situation would arise, for example, when the sites
are all participating in a disease specific registry. The parties NCP1
and NCP2 would probably be set up once and any new site that has to be
onboarded needs only to be known to P1 and P2. This has the added
advantage of hiding the number of sites, which could even be 1!</p>
<p>Such a communication topology would mean that the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
values have be funneled to the sites through NCP1 and NCP2 and that can
be easily accomplished. The picture below shows this configuration and
looks more complicated than it actually is.</p>
<p><img src="assets%2Fnon_cooperating_query_masters.png"></p>
<p>To summarize, the modified scheme has several characteristics:</p>
<ul>
<li>The master only communicates with NCP1 and NCP2</li>
<li>NCP1 and NCP2 are the only parties communicating with both the
master and sites</li>
<li>NCP1 and NCP2 are the only ones that know how many sites are
participating</li>
<li>New sites can be added and only NCP1 and NCP2 need to account for
them while the master remains oblivous to the number of sites; so
<em>the scheme works even with one site</em>
</li>
<li>It appears that there is unnecessary communication of the same
information,
i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is being sent twice to each site from each of the NCP1 and NCP2. This is
easily mitigated by engineering either by using a broker between NCP1
and NCP2, or the sites caching their results for a short period to avoid
recomputation.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h2>
<p>The above implementation assumes that the encryption and decryption
can happen with real numbers which is not the actual situation. Instead,
we use rational approximations using a large denominator,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>2</mn><mn>256</mn></msup><annotation encoding="application/x-tex">2^{256}</annotation></semantics></math>,
say. In the future, of course, we need to build an actual library is
built with rigorous algorithms guaranteeing precision and
overflow/undeflow detection. For now, this is just an ad hoc
implementation.</p>
<p>Also, since we are only using homomorphic additive properties, a
partial homomorphic scheme such as the Paillier Encryption system will
be sufficient for our computations.</p>
<p>We define classes to encapsulate our sites, non-cooperating parties
and a master process.</p>
<div class="section level3">
<h3 id="the-site-class">The Site Class<a class="anchor" aria-label="anchor" href="#the-site-class"></a>
</h3>
<p>Our site class will compute the count on site data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Site</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>            <span class="st">"Site"</span>,</span>
<span>            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## name of the site</span></span>
<span>                name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## local data</span></span>
<span>                data <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                result_cache <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                filterCondition <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                local_query_count <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="co">## Check if value is cached</span></span>
<span>                    <span class="va">result</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">result_cache</span></span>
<span>                    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="co">## We need to run the query</span></span>
<span>                        <span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span></span>
<span>                        <span class="co">## Generate random offset for int and frac parts</span></span>
<span>                        <span class="va">offset.int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random.bigz.html">random.bigz</a></span><span class="op">(</span>nBits <span class="op">=</span> <span class="fl">256</span><span class="op">)</span></span>
<span>                        <span class="co">## 2. Add to count</span></span>
<span>                        <span class="va">data</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">data</span></span>
<span>                        <span class="va">filter_expr</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"rlang::expr("</span>, <span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                        <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>                            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span> <span class="va">filter_expr</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>                            <span class="va">result.int</span></span>
<span>                        <span class="va">result</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                            int1 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.int</span> <span class="op">-</span> <span class="va">offset.int</span><span class="op">)</span>,</span>
<span>                            int2 <span class="op">=</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="va">result.int</span> <span class="op">+</span> <span class="va">offset.int</span><span class="op">)</span></span>
<span>                        <span class="op">)</span></span>
<span>                        <span class="va">private</span><span class="op">$</span><span class="va">result_cache</span>  <span class="op">&lt;-</span> <span class="va">result</span></span>
<span>                    <span class="op">}</span></span>
<span>                    <span class="va">result</span></span>
<span>                <span class="op">}</span></span>
<span>            <span class="op">)</span>,</span>
<span>            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## Common denominator for approximate real arithmetic</span></span>
<span>                den <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## The master's public key; everyone has this</span></span>
<span>                pubkey <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setPublicKey <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">pubkey</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setDenominator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">den</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">=</span> <span class="va">den</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setFilterCondition <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">filterCondition</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span>  <span class="op">&lt;-</span> <span class="va">filterCondition</span></span>
<span>                <span class="op">}</span>,</span>
<span>                <span class="co">## query count,</span></span>
<span>                query_count <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">party</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">result</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="fu">local_query_count</span><span class="op">(</span><span class="op">)</span></span>
<span>                    <span class="kw">if</span> <span class="op">(</span><span class="va">party</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="va">result</span><span class="op">$</span><span class="va">int1</span> <span class="kw">else</span> <span class="va">result</span><span class="op">$</span><span class="va">int2</span></span>
<span>                <span class="op">}</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-non-cooperating-parties-class">The Non-cooperating Parties Class<a class="anchor" aria-label="anchor" href="#the-non-cooperating-parties-class"></a>
</h3>
<p>The non-cooperating parties can communicate with the sites. So they
have methods for adding sites, passing on public keys from the master
etc. The <code>query_count</code> method for this class merely calls
each site to compute the result and adds them up before sending it on to
the master, so that the master has no idea of the individual
contributions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NCParty</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>            <span class="st">"NCParty"</span>,</span>
<span>            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## name of the site</span></span>
<span>                name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## NC party number</span></span>
<span>                number <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## filter condition</span></span>
<span>                filterCondition <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## The master</span></span>
<span>                master <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## The sites</span></span>
<span>                sites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>            <span class="op">)</span>,</span>
<span>            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## The master's public key; everyone has this</span></span>
<span>                pubkey <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## The denoinator for rational arithmetic</span></span>
<span>                den <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">number</span>  <span class="op">&lt;-</span> <span class="va">number</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setPublicKey <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span> <span class="op">&lt;-</span> <span class="va">pubkey</span></span>
<span>                    <span class="co">## Propagate to sites</span></span>
<span>                    <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">site</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">pubkey</span><span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setDenominator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">den</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">&lt;-</span> <span class="va">den</span></span>
<span>                    <span class="co">## Propagate to sites</span></span>
<span>                    <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">site</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">den</span><span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setFilterCondition <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">filterCondition</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span>  <span class="op">&lt;-</span> <span class="va">filterCondition</span></span>
<span>                    <span class="co">## Propagate to sites</span></span>
<span>                    <span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">site</span><span class="op">$</span><span class="fu">setFilterCondition</span><span class="op">(</span><span class="va">filterCondition</span><span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">}</span>,</span>
<span>                addSite <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">sites</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">sites</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span></span>
<span>                <span class="op">}</span>,</span>
<span>                <span class="co">## sum of all counts</span></span>
<span>                query_count <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">pubkey</span>  <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">pubkey</span></span>
<span>                    <span class="va">results</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sites</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="fu">query_count</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">number</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="co">## Accumulate the integer and fractional parts</span></span>
<span>                    <span class="va">n</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>                    <span class="va">enc_sum</span> <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">encrypt</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>                    <span class="kw">for</span> <span class="op">(</span><span class="va">result</span> <span class="kw">in</span> <span class="va">results</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">enc_sum</span>  <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">enc_sum</span>, <span class="va">result</span><span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                    <span class="va">enc_sum</span></span>
<span>                <span class="op">}</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-master-class">The Master Class<a class="anchor" aria-label="anchor" href="#the-master-class"></a>
</h3>
<p>The master process</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Master</span>  <span class="op">&lt;-</span></span>
<span>    <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>            <span class="st">"Master"</span>,</span>
<span>            private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## name of the site</span></span>
<span>                name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## Private and public keys</span></span>
<span>                keys <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## Non cooperating party 1</span></span>
<span>                nc_party_1 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## Non cooperating party 2</span></span>
<span>                nc_party_2 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                <span class="co">## filter condition</span></span>
<span>                filterCondition <span class="op">=</span> <span class="cn">NA</span></span>
<span>            <span class="op">)</span>,</span>
<span>            public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                <span class="co">## Denominator for rational arithmetic</span></span>
<span>                den  <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">filterCondition</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">name</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PaillierKeyPair.html">PaillierKeyPair</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fl">1024</span><span class="op">)</span> <span class="co">## Generate new public and private key.</span></span>
<span>                    <span class="va">self</span><span class="op">$</span><span class="va">den</span> <span class="op">&lt;-</span> <span class="fu">gmp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gmp/man/bigrational.html" class="external-link">as.bigq</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">256</span>  <span class="co">#Our denominator for rational approximations</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span>  <span class="op">&lt;-</span> <span class="va">filterCondition</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setNCParty1  <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span> <span class="op">&lt;-</span> <span class="va">site</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span><span class="op">)</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">setFilterCondition</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span><span class="op">)</span></span>
<span>                <span class="op">}</span>,</span>
<span>                setNCParty2  <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span> <span class="op">&lt;-</span> <span class="va">site</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">setPublicKey</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span><span class="op">)</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">setDenominator</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">den</span><span class="op">)</span></span>
<span>                    <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">setFilterCondition</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">filterCondition</span><span class="op">)</span></span>
<span>                <span class="op">}</span>,</span>
<span>                <span class="co">## Query count</span></span>
<span>                query_count <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">pubkey</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="va">pubkey</span></span>
<span>                    <span class="va">privkey</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">keys</span><span class="op">$</span><span class="fu">getPrivateKey</span><span class="op">(</span><span class="op">)</span></span>
<span>                    <span class="va">result1</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">nc_party_1</span><span class="op">$</span><span class="fu">query_count</span><span class="op">(</span><span class="op">)</span></span>
<span>                    <span class="va">result2</span>  <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">nc_party_2</span><span class="op">$</span><span class="fu">query_count</span><span class="op">(</span><span class="op">)</span></span>
<span>                    <span class="co">## Sum it</span></span>
<span>                    <span class="va">enc_sum</span> <span class="op">&lt;-</span> <span class="va">pubkey</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">result1</span>, <span class="va">result2</span><span class="op">)</span></span>
<span>                    <span class="va">final_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">privkey</span><span class="op">$</span><span class="fu">decrypt</span><span class="op">(</span><span class="va">enc_sum</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="co">## Since we 2c, we divide by 2.</span></span>
<span>                    <span class="va">final_result</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>                <span class="op">}</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>We are now ready to use our sites in the computation.</p>
<div class="section level3">
<h3 id="create-sites">1. Create sites<a class="anchor" aria-label="anchor" href="#create-sites"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site1</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 1"</span>, data <span class="op">=</span> <span class="va">query_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">site2</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 2"</span>, data <span class="op">=</span> <span class="va">query_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">site3</span> <span class="op">&lt;-</span> <span class="va">Site</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Site 3"</span>, data <span class="op">=</span> <span class="va">query_data</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sites</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>site1 <span class="op">=</span> <span class="va">site1</span>, site2 <span class="op">=</span> <span class="va">site2</span>, site3 <span class="op">=</span> <span class="va">site3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-non-cooperating-parties">2. Create Non-cooperating parties<a class="anchor" aria-label="anchor" href="#create-non-cooperating-parties"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncp1</span>  <span class="op">&lt;-</span> <span class="va">NCParty</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"NCP1"</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ncp2</span>  <span class="op">&lt;-</span> <span class="va">NCParty</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"NCP1"</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>We add sites to the non-cooperating parties.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">sites</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ncp1</span><span class="op">$</span><span class="fu">addSite</span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">ncp2</span><span class="op">$</span><span class="fu">addSite</span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-the-master-process">3. Create the master process<a class="anchor" aria-label="anchor" href="#create-the-master-process"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">master</span>  <span class="op">&lt;-</span> <span class="va">Master</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Master"</span>,</span>
<span>                      filterCondition <span class="op">=</span> <span class="st">"age &lt; 50 &amp; sex == 'F' &amp; bm &lt; 0.2"</span><span class="op">)</span></span></code></pre></div>
<p>We next connect the master to the non-cooperating parties.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">master</span><span class="op">$</span><span class="fu">setNCParty1</span><span class="op">(</span><span class="va">ncp1</span><span class="op">)</span></span>
<span><span class="va">master</span><span class="op">$</span><span class="fu">setNCParty2</span><span class="op">(</span><span class="va">ncp2</span><span class="op">)</span></span></code></pre></div>
<p>At this point the communication graph has been defined between the
master and non-cooperating parties and the non-cooperating parties and
the sites.</p>
</div>
<div class="section level3">
<h3 id="perform-the-query">4. Perform the Query<a class="anchor" aria-label="anchor" href="#perform-the-query"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Query Count is %d\n"</span>, <span class="va">master</span><span class="op">$</span><span class="fu">query_count</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Query Count is 11</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://naras.su.domains" class="external-link">Balasubramanian Narasimhan</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
